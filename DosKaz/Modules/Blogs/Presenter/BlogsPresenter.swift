//
//  BlogsPresenter.swift
//  Blogs
//
//  Generated by ModuleGenerator.
//  Copyright Â© 2020-05-14 17:21:04 +0000 lobster.kz. All rights reserved.
//

import SharedCodeFramework
		
class BlogsPresenter {
	
	weak var view: BlogsViewInput!
	var interactor: BlogsInteractorInput!
	var router: BlogsRouterInput!

	var items = [Item]()
	var currentQuery: String!
	var currentCategory: BlogCategory!
}

// MARK: ViewController output protocol

protocol BlogsViewOutput {
	func viewIsReady()
}

extension BlogsPresenter: BlogsViewOutput {
	func viewIsReady() {
		view.setupInitialState()
		view.onSearchFieldEdit = CommandWith<String> { query in
			self.items.removeAll()
			self.view.updateTable(with: [])
			self.interactor.resetPaginator()
			self.currentQuery = query.isEmpty ? nil : query
			self.currentCategory = nil
			self.interactor.searchPosts(with: self.currentQuery, categoryId: nil)
		}
		interactor.loadPosts(with: self.currentQuery, categoryId: nil)
		view.onSelect = CommandWith<Item> { [weak self] blog in
			guard let self = self else { return }
			self.router.showBlog(with: self.view, blog: blog)
		}
		view.onTouchFilter = Command { [weak self] in
			self?.interactor.loadBlogCategories()
		}
		view.onSelectCategory = CommandWith { [weak self] category in
			self?.items.removeAll()
			self?.view.updateTable(with: [])
			self?.interactor.resetPaginator()
			self?.currentQuery = nil
			self?.currentCategory = category
			self?.interactor.loadPosts(with: nil, categoryId: category.id)
		}
		view.onScrollToBottom = Command { [weak self] in
			self?.interactor.loadPosts(with: self?.currentQuery, categoryId: self?.currentCategory?.id)
		}
	}

}

// MARK: Interactor output protocol

protocol BlogsInteractorOutput: class {
	func didload(_ blogResponse: BlogResponse)
	func didFailLoadBlogResponse(with error: Error)
	func didLoad(_ blogCategories: [BlogCategory])
	func didLoadSearch(_ response: BlogResponse)
}

extension BlogsPresenter: BlogsInteractorOutput {
	func didLoadSearch(_ response: BlogResponse) {
		let cellsProps = response.items.map {
			BlogCell.Props(
				item: $0,
				title: $0.title,
				imageURL: $0.image,
				content: $0.annotation ?? "",
				lastLine: $0.datePublished + "  " + $0.categoryName
			)
		}
		view.updateTable(with: cellsProps)
	}

	func didload(_ blogResponse: BlogResponse) {
		items.append(contentsOf: blogResponse.items)
		let cellsProps = items.map {
			BlogCell.Props(
				item: $0,
				title: $0.title,
				imageURL: $0.image,
				content: $0.annotation ?? "",
				lastLine: $0.datePublished + "  " + $0.categoryName
			)
		}
		view.updateTable(with: cellsProps)
	}
	
	func didFailLoadBlogResponse(with error: Error) {
		view.updateTable(with: [])
	}
	
	func didLoad(_ blogCategories: [BlogCategory]) {
		view.showActionSheet(with: blogCategories)
	}
}
